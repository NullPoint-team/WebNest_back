<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.webnest.mapper.UserMapper">
  <select id="select" parameterType="Long" resultType="UserVO">
    SELECT
    ID, USER_EMAIL, USER_PASSWORD, USER_THUMBNAIL_URL,
    USER_THUMBNAIL_NAME, USER_NAME, USER_NICKNAME, USER_PROVIDER
    FROM TBL_USER
    WHERE ID = #{id}
  </select>

  <select id="selectIdByUserEmail" parameterType="String" resultType="Long">
    SELECT ID
    FROM TBL_USER
    WHERE USER_EMAIL = #{userEmail}
  </select>

  <select id="selectAll" resultType="UserVO">
    SELECT
    ID, USER_EMAIL, USER_PASSWORD, USER_THUMBNAIL_URL,
    USER_THUMBNAIL_NAME, USER_NAME, USER_NICKNAME, USER_PROVIDER
    FROM TBL_USER
  </select>

  <select id="existsByUserEmail" parameterType="String" resultType="_boolean">
    SELECT
    CASE
    WHEN COUNT(ID) > 0 THEN 1 ELSE 0
    END
    FROM TBL_USER
    WHERE USER_EMAIL = #{userEmail}
  </select>

  <!-- 일반 멤버 추가 -->
  <insert id="insert" parameterType="UserVO">
    INSERT INTO TBL_USER (
      ID,
      USER_NAME,
      USER_BIRTHDAY,
      USER_EMAIL,
      USER_PHONE,
      USER_PASSWORD,
      USER_NICKNAME,
      USER_PROVIDER
    )
    VALUES (
      SEQ_USER.NEXTVAL,
      #{userName},
      #{userBirthday},
      #{userEmail},
      #{userPhone},
      #{userPassword},
      #{userName},
      #{userProvider}
    )
  </insert>



  <!-- 소셜 멤버 추가 -->
  <insert id="insertSocial" parameterType="UserInsertSocialVO">
    INSERT INTO TBL_USER (
    ID,
    USER_NAME,
    USER_BIRTHDAY,
    USER_EMAIL,
    USER_PHONE,
    USER_PASSWORD,
    USER_NICKNAME,
    USER_PROVIDER
    )
    VALUES (
    SEQ_USER.NEXTVAL,
    #{userName},
    #{userBirthday},
    #{userEmail},
    #{userPhone},
    #{userPassword},
    #{userName},
    #{userProvider}
    )
  </insert>

  <update id="update" parameterType="UserVO">
    UPDATE TBL_USER
    SET
    USER_PASSWORD = #{userPassword}, USER_THUMBNAIL_URL = #{userThumbnailUrl}, USER_THUMBNAIL_NAME = #{userThumbnailName},
    USER_NAME = #{userName}, USER_NICKNAME = #{userNickname}, USER_PROVIDER = #{userProvider}
    WHERE ID = #{id}
  </update>

  <delete id="delete" parameterType="Long">
    DELETE FROM TBL_USER
    WHERE ID = #{id}
  </delete>

<!--    승찬 기생중 -->
    <select id="selectByQuery" resultType="UserVO" parameterType="String">
        SELECT ID, USER_NAME, USER_BIRTHDAY, USER_EMAIL, USER_PHONE, USER_AGE, USER_EXP, USER_LEVEL, USER_THUMBNAIL_NAME, USER_THUMBNAIL_URL, USER_NICKNAME, USER_PASSWORD
        FROM TBL_USER
        WHERE USER_NICKNAME LIKE '%'||#{query}||'%'
    </select>
    <select id="selectQuestionPostQByQuery" resultType="PostSearchDTO" parameterType="String">
        SELECT TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT,
            TBP.POST_CREATE_AT, TBP.POST_VIEW_COUNT, TBP.POST_TYPE, TBP.USER_ID,
            TBU.USER_LEVEL, TBU.USER_THUMBNAIL_URL, TBU.USER_NICKNAME,
            COUNT(TBC.ID) AS COMMENT_COUNT
        FROM (
            SELECT ID, POST_TITLE, POST_CONTENT, POST_CREATE_AT, POST_VIEW_COUNT,
                POST_TYPE, USER_ID FROM TBL_POST
            WHERE POST_TYPE = 'JS' OR POST_TYPE = 'JAVA' OR POST_TYPE = 'ORACLE'
        ) TBP
        JOIN TBL_USER TBU
        ON TBP.USER_ID = TBU.ID
        LEFT JOIN TBL_COMMENT TBC
        ON TBP.ID = TBC.POST_ID
        GROUP BY TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT, TBP.POST_CREATE_AT,
            TBP.POST_VIEW_COUNT, TBP.POST_TYPE, TBP.USER_ID, TBU.USER_NICKNAME,
            TBU.USER_LEVEL, TBU.USER_THUMBNAIL_URL
        HAVING TBP.POST_CONTENT LIKE '%'||#{query}||'%'
            OR TBP.POST_TITLE LIKE '%'||#{query}||'%'
        ORDER BY TBP.ID
    </select>
    <select id="selectOpenPostQByQuery" resultType="PostSearchDTO" parameterType="String">
        SELECT TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT,
            TBP.POST_CREATE_AT, TBP.POST_VIEW_COUNT, TBP.POST_TYPE, TBP.USER_ID,
            TBU.USER_LEVEL, TBU.USER_THUMBNAIL_URL, TBU.USER_NICKNAME,
            COUNT(TBC.ID) AS COMMENT_COUNT
        FROM (
            SELECT ID, POST_TITLE, POST_CONTENT, POST_CREATE_AT, POST_VIEW_COUNT,
            POST_TYPE, USER_ID FROM TBL_POST WHERE POST_TYPE = 'OPEN'
        ) TBP
        JOIN TBL_USER TBU
        ON TBP.USER_ID = TBU.ID
        LEFT JOIN TBL_COMMENT TBC
        ON TBP.ID = TBC.POST_ID
        GROUP BY TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT, TBP.POST_CREATE_AT,
            TBP.POST_VIEW_COUNT, TBP.POST_TYPE, TBP.USER_ID, TBU.USER_NICKNAME,
            TBU.USER_LEVEL, TBU.USER_THUMBNAIL_URL
        HAVING TBP.POST_CONTENT LIKE '%'||#{query}||'%'
            OR TBP.POST_TITLE LIKE '%'||#{query}||'%' ORDER BY TBP.ID
    </select>


    <select id="selectQuizByQuery" resultType="QuizVO" parameterType="String">
        SELECT ID, QUIZ_TITLE, QUIZ_DESCRIPTION, QUIZ_CATEGORY, QUIZ_EXPECTATION, QUIZ_EXP, QUIZ_DIFFICULT, QUIZ_LANGUAGE
        FROM TBL_QUIZ
        WHERE QUIZ_TITLE LIKE '%'||#{query}||'%' OR QUIZ_DESCRIPTION LIKE '%'||#{query}||'%'
            OR QUIZ_CATEGORY LIKE '%'||#{query}||'%' OR QUIZ_EXPECTATION LIKE '%'||#{query}||'%'
            OR QUIZ_DIFFICULT LIKE '%'||#{query}||'%' OR QUIZ_LANGUAGE LIKE '%'||#{query}||'%'
    </select>

    <select id="selectPostNotificationByUserId" resultType="PostNotificationDTO" parameterType="Long">
        SELECT tbpn.ID , tbpn.POST_NOTIFICATION_ACTION, tbpn.POST_NOTIFICATION_IS_READ, tbpn.POST_NOTIFICATION_CREATE_AT,
            tbu.USER_THUMBNAIL_URL, tbu.USER_LEVEL, tbu.USER_NICKNAME, tbpn.ACTOR_USER_ID, tbpn.RECEIVER_USER_ID
        FROM (
            SELECT ID, POST_NOTIFICATION_CREATE_AT, POST_NOTIFICATION_IS_READ, POST_NOTIFICATION_ACTION, ACTOR_USER_ID, RECEIVER_USER_ID
            FROM TBL_POST_NOTIFICATION
            WHERE RECEIVER_USER_ID = #{receiverUserId}
                AND POST_NOTIFICATION_IS_READ = 0   --화면에서 받을 유저아이디 + 읽음 처리가 안 된 것들
                AND POST_NOTIFICATION_CREATE_AT >= SYSTIMESTAMP - INTERVAL '7' DAY
        ) tbpn
        JOIN  TBL_USER tbu
        ON  tbpn.ACTOR_USER_ID = tbu.ID
    </select>
    <select id="selectCommentNotificationByUserId" resultType="CommentNotificationDTO" parameterType="Long">
        SELECT tbcn.ID , tbcn.COMMENT_NOTIFICATION_ACTION, tbcn.COMMENT_NOTIFICATION_IS_READ, tbcn.COMMENT_NOTIFICATION_CREATE_AT,
            tbcn.COMMENT_ID, tbu.USER_THUMBNAIL_URL, tbu.USER_LEVEL, tbu.USER_NICKNAME, tbcn.ACTOR_USER_ID, tbcn.RECEIVER_USER_ID, tc.POST_ID, tp.POST_TITLE , tp.POST_CONTENT
        FROM (
            SELECT ID, COMMENT_NOTIFICATION_CREATE_AT, COMMENT_NOTIFICATION_IS_READ, COMMENT_NOTIFICATION_ACTION, ACTOR_USER_ID, RECEIVER_USER_ID, COMMENT_ID
            FROM TBL_COMMENT_NOTIFICATION
            WHERE RECEIVER_USER_ID = 1
                AND COMMENT_NOTIFICATION_IS_READ = 0   --화면에서 받을 유저아이디 + 읽음 처리가 안 된 것들
                AND COMMENT_NOTIFICATION_CREATE_AT >= CURRENT_TIMESTAMP - INTERVAL '7' DAY
            ) tbcn
        JOIN  TBL_USER tbu
        ON  tbcn.ACTOR_USER_ID = tbu.ID
        JOIN TBL_COMMENT tc
        ON tbcn.COMMENT_ID = tc.ID
        JOIN TBL_POST tp
        ON tc.POST_ID = tp.ID
        ORDER BY tbcn.COMMENT_NOTIFICATION_CREATE_AT DESC
    </select>
    <select id="selectFollowNotificationByUserId" resultType="FollowNotificationDTO" parameterType="Long">
        SELECT tfn.ID, tfn.FOLLOW_NOTIFICATION_CREATE_AT,tfn.ACTOR_USER_ID, tu.USER_NICKNAME, tu.USER_LEVEL, tu.USER_THUMBNAIL_URL
        FROM TBL_FOLLOW_NOTIFICATION tfn
        LEFT JOIN TBL_USER tu
        ON tfn.ACTOR_USER_ID = tu.ID
        WHERE tfn.RECEIVER_USER_ID = 1
        ORDER BY tfn.FOLLOW_NOTIFICATION_CREATE_AT DESC
    </select>
    <insert id="insetPostNotification" parameterType="PostNotificationVO">
        INSERT INTO TBL_POST_NOTIFICATION(ID, POST_NOTIFICATION_ACTION, ACTOR_USER_ID, RECEIVER_USER_ID, POST_ID)
        VALUES (SEQ_POST_NOTIFICATION.NEXTVAL, #{postNotificationAction} , #{actorUserId}, #{receiverUserId}, #{postId});
    </insert>
    <insert id="insertCommentNotification" parameterType="CommentNotificationVO">
        INSERT INTO TBL_COMMENT_NOTIFICATION(ID, COMMENT_NOTIFICATION_ACTION, RECEIVER_USER_ID, ACTOR_USER_ID, COMMENT_ID)
        VALUES (SEQ_COMMENT_NOTIFICATION.NEXTVAL, #{postNotificationAction}, #{receiverUserId}, #{actorUserId}, #{commentId})
    </insert>
    <insert id="insertFollowNotification" parameterType="FollowNotificationVO">
        INSERT INTO TBL_FOLLOW_NOTIFICATION(ID, RECEIVER_USER_ID, ACTOR_USER_ID, FOLLOW_ID)
        VALUES (SEQ_FOLLOW_NOTIFICATION.NEXTVAL, #{receiverUserId}, #{actorUserId} ,#{followId})
    </insert>
<!--    승찬 기생중 -->
</mapper>